#!/bin/bash
# Pre-commit hook for bunnypmsl
# Runs formatting, tests, and checks before allowing commit

set -e

CARGO="${HOME}/.local/share/mise/shims/cargo"

echo "Running pre-commit checks..."
echo ""

# Format code automatically (moved to first for best UX)
echo "üé® Formatting code..."
${CARGO} fmt --all

# Re-add any Rust files that were modified by formatting
FORMATTED_FILES=$(git diff --name-only | grep '\.rs$' || true)
if [[ -n "${FORMATTED_FILES}" ]]; then
	echo "${FORMATTED_FILES}" | xargs git add
	FILE_COUNT=$(echo "${FORMATTED_FILES}" | wc -l | tr -d ' ' || true)
	echo "‚úÖ Formatted and re-staged ${FILE_COUNT} file(s)"
else
	echo "‚úÖ No files needed formatting"
fi

# Run cargo check (fast compilation check)
echo ""
echo "üîç Running cargo check..."
${CARGO} check --all-features

# Run clippy (linter)
echo ""
echo "üîß Running cargo clippy..."
${CARGO} clippy --all-features -- -D warnings

# Run tests
echo ""
echo "üß™ Running cargo test..."
${CARGO} test --all-features

echo ""
echo "‚úÖ All checks passed! Proceeding with commit."
